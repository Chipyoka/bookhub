<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/styles.css" />
  <title>Cart & Checkout | Bookhub </title>
</head>
<body>
  <!-- Header -->
  <div class="top">
    <div class="flex-2">
      <div class="breathing-pulse"></div>
      <p id="typewrite">The best of christianity books - all here !</p>
      <div class="breathing-pulse"></div>
    </div>
  </div>

  <header>
    <div class="flex">
      <div><img src="./images/logo.png" alt="Bookhub" height="36px" /></div>
      <nav>
        <a href="index.html">Home</a>
        <a href="products.html">Books</a>
      </nav>
    </div>

    <!-- Search Field -->
    <div class="search-box">
      <form id="search-form" class="search-form">
        <input type="text" id="search-input" placeholder="Search books..." required />
        <button title="search" type="submit">
          <img src="./images/search.png" alt="search" width="44px" />
        </button>
      </form>
    </div>

    <div class="cta">
      <div>
        <button class="cart-btn">
          <a href="checkout.html">
            <img src="./images/cart_.png" alt="cart" width="28px" />
            <span class="cart-count" id="cart-count">0</span>
          </a>
        </button>

        <button>
          <a href="profile.html" title="My Profile">
            <img src="./images/profile_.png" alt="account" width="28px" />
          </a>
        </button>
      </div>
      <button><a href="register.html">Register</a></button>
    </div>
  </header>

  <!-- Cart Summary -->
  <div class="cart-total-summary">
    <div id="total-items">0</div>
    <div id="cart-total-amount">K0.00</div>
  </div>

  <main class="cart-page">

    <!-- Checkout Section -->
    <section class="checkout-form">
      <h2>Shipping Information</h2>
      <div class="user-info-notice" id="userInfoNotice" style="display: none;">
        <p><strong>We found your profile information!</strong> <br> Please review and update if needed before proceeding.</p>
      </div>
      
      <form id="checkoutForm">
        <label for="name">Full Name *</label>
        <input type="text" id="name" name="name" required />

        <label for="phone">Active Phone Number *</label>
        <input type="text" id="phone" name="phone" required />

        <label for="address">Shipping Address *</label>
        <textarea id="address" name="address" rows="3" required></textarea>

        <button type="submit" class="btn-checkout">Proceed to Payment</button>
      </form>

      <div class="pays">
        We accept:
        <img src="./images/visa_.png" alt="Visa" width="40px">
        <img src="./images/mastercard_.png" alt="Visa" width="42px">
        <img src="./images/gpay_.png" alt="Visa" width="40px">
      </div>
    </section>

    <!-- Cart Section -->
    <section class="cart-items">
      <h2>Your Cart</h2>
      <div class="cart-list">
        <div class="cart-item">
          <p>Cart items will show here</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="info">
      <h1>Bookhub</h1>
      <p>
        An online Christian bookstore offering a carefully curated collection of books.
        Browse our catalog, and build your collection with us. Your trusted source for
        faith-based literature delivered with convenience and care.
      </p>

      <div class="addr">
        <p class="cap">Contact information</p>
        <p>
          Kalewa Rd, Northrise<br />
          Ndola - Zambia
        </p>
        <p><strong>Call: </strong>0972 691448 | 0976 553642</p>
      </div>
      <code>Powered by <img src="./images/stripe.png" alt="Stripe" width="40px"></code>
    </div>

    <div class="q-links">
      <div>
        <h4>Company</h4>
        <ul>
          <li><a href="#">Home</a></li>
          <li><a href="./products.html">Books</a></li>
          <li><a href="./checkout.html">Cart</a></li>
          <li><a href="#">About Us</a></li>
        </ul>
      </div>
      <div>
        <h4>Legal</h4>
        <ul>
          <li><a href="#">Refund Policy</a></li>
          <li><a href="#">Shipping</a></li>
          <li><a href="#">Terms and Conditions</a></li>
          <li><a href="#">Cookie Policy</a></li>
        </ul>
      </div>
    </div>
  </footer>
  <div class="sign">
    2025 &copy; All rights Reserved |
    <strong>Designed and Developed by Kamila and Chipyoka</strong> as part of an assignment.
  </div>

  <!-- JS -->
  <script type="module">
    // Wait for DOM to load
    document.addEventListener("DOMContentLoaded", () => {
      // Render existing cart from localStorage
      if (window.renderCart) renderCart();

      // Pre-fill form with user data if available
      prefillUserData();

      const form = document.getElementById("checkoutForm");
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        // Get cart
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        if (cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }

        // Get shipping info from form
        const shipping = {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          address: document.getElementById("address").value.trim(),
        };

        // Validate shipping information
        if (!validateShippingInfo(shipping)) {
          return;
        }

        // Calculate totals
        const totalAmount = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);

        // Compile order object
        const pendingOrder = {
          shipping,
          cart,
          totalAmount,
          totalItems,
          createdAt: new Date().toISOString(),
        };

        // Save for payments page
        localStorage.setItem("pendingOrder", JSON.stringify(pendingOrder));

        // Redirect to payments page
        window.location.href = "payment.html";
      });
    });

    // Pre-fill form with user data from localStorage
    function prefillUserData() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        return;
      }

      // Show notice that we found user info
      const notice = document.getElementById("userInfoNotice");
      notice.style.display = 'block';

      // Pre-fill form fields with user data if they exist and form fields are empty
      const nameField = document.getElementById("name");
      const phoneField = document.getElementById("phone");
      const addressField = document.getElementById("address");

      if (user.full_name && !nameField.value) {
        nameField.value = user.full_name;
      }
      
      if (user.phone && !phoneField.value) {
        phoneField.value = user.phone;
      }
      
      if (user.address && !addressField.value) {
        addressField.value = user.address;
      }
    }

    // Validate shipping information
    function validateShippingInfo(shipping) {
      const { name, phone, address } = shipping;

      // Check if any field is empty
      if (!name || !phone || !address) {
        alert("Please fill in all shipping information fields.\n\nAll fields marked with * are required to process your order.");
        return false;
      }

      // Validate phone number format (basic validation)
      const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
      if (!phoneRegex.test(phone)) {
        alert("Please enter a valid phone number.\n\nExample: 0972 123456 or +260972123456");
        return false;
      }

      // Validate address length
      if (address.length < 10) {
        alert("Please provide a complete shipping address.\n\nYour address should include street name, area, and city for proper delivery.");
        return false;
      }

      // Validate name (should have at least 2 words)
      const nameParts = name.trim().split(/\s+/);
      if (nameParts.length < 2) {
        alert("Please provide your full name (first and last name).");
        return false;
      }

      return true;
    }

    // Check user data completeness and warn if incomplete
    function checkUserDataCompleteness() {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        return;
      }

      const missingFields = [];
      if (!user.full_name) missingFields.push('full name');
      if (!user.phone) missingFields.push('phone number');
      if (!user.address) missingFields.push('address');

      if (missingFields.length > 0) {
        console.log(`User profile missing: ${missingFields.join(', ')} - using checkout form instead`);
      }
    }

    // Run user data completeness check on load
    checkUserDataCompleteness();
  </script>

  <script type="module" src="./js/cart.js"></script>
</body>
</html>